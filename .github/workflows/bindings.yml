name: UniFFI bindings

run-name: Build libraries and generate bindings

permissions:
  contents: read

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  MISE_ENV: ci

jobs:
  build-libs:
    name: Build lib (${{ matrix.platform_id }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform_id: darwin-x86_64
            runner: macos-15-intel
            target: x86_64-apple-darwin
            lib_file: libfeeling_rusty.dylib
          - platform_id: darwin-arm64
            runner: macos-14
            target: aarch64-apple-darwin
            lib_file: libfeeling_rusty.dylib
          - platform_id: linux-x86_64
            runner: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            lib_file: libfeeling_rusty.so
          - platform_id: linux-arm64
            runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            lib_file: libfeeling_rusty.so
          - platform_id: windows-x86_64
            runner: windows-latest
            target: x86_64-pc-windows-msvc
            lib_file: feeling_rusty.dll
          - platform_id: windows-arm64
            runner: windows-11-arm
            target: aarch64-pc-windows-msvc
            lib_file: feeling_rusty.dll
    steps:
      - uses: actions/checkout@v6

      - uses: jdx/mise-action@v3

      - uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-${{ runner.os }}-${{ matrix.platform_id }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Rust target
        run: rustup target add ${{ matrix.target }}

      - name: Build release cdylib
        run: cargo build --release --target ${{ matrix.target }} --lib

      - name: Copy library to staging
        shell: bash
        run: |
          mkdir -p staging
          cp "target/${{ matrix.target }}/release/${{ matrix.lib_file }}" staging/

      - name: Upload library artifact
        uses: actions/upload-artifact@v4
        with:
          name: lib-${{ matrix.platform_id }}
          path: staging/
          retention-days: 3

  build-bindgen:
    name: Build uniffi-bindgen
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v6

      - uses: jdx/mise-action@v3

      - uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-${{ runner.os }}-bindgen-${{ hashFiles('**/Cargo.lock') }}

      - name: Build uniffi-bindgen binary
        run: cargo build --release --bin uniffi-bindgen --features cli

      - name: Upload uniffi-bindgen binary
        uses: actions/upload-artifact@v4
        with:
          name: uniffi-bindgen-binary
          path: target/release/uniffi-bindgen
          retention-days: 3

  bindings:
    name: Bindings (${{ matrix.language }})
    needs: [build-libs, build-bindgen]
    runs-on: ubuntu-24.04-arm
    strategy:
      fail-fast: false
      matrix:
        language: [kotlin, swift, python, ruby]
    steps:
      - uses: actions/checkout@v6

      - name: Download uniffi-bindgen binary
        uses: actions/download-artifact@v4
        with:
          name: uniffi-bindgen-binary

      - name: Locate bindgen binary
        id: bindgen
        run: |
          BINDGEN=$(find . -name uniffi-bindgen -type f | head -1)
          chmod +x "$BINDGEN"
          echo "path=$BINDGEN" >> "$GITHUB_OUTPUT"

      # Any one library has the same embedded API metadata; we only need it to run bindgen
      - name: Download library artifact (any platform)
        id: download-lib
        uses: actions/download-artifact@v4
        with:
          name: lib-linux-x86_64

      - name: Detect library path
        id: lib
        run: |
          LIB_DIR="${{ steps.download-lib.outputs.download-path }}"
          LIB_PATH=$(find "$LIB_DIR" -type f \( -name '*.dylib' -o -name '*.so' -o -name '*.dll' \) | head -1)
          if [ -z "$LIB_PATH" ]; then
            echo "::error::No library file found in $LIB_DIR"
            exit 1
          fi
          echo "path=$LIB_PATH" >> "$GITHUB_OUTPUT"

      - name: Generate bindings
        run: |
          "${{ steps.bindgen.outputs.path }}" generate \
            --library "${{ steps.lib.outputs.path }}" \
            --language ${{ matrix.language }} \
            --out-dir out

      - name: Upload bindings artifact
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.language }}
          path: out/
          retention-days: 3

  package-python:
    name: Package Python (${{ matrix.platform_id }})
    needs: bindings
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform_id: darwin-x86_64
            runner: macos-15-intel
          - platform_id: darwin-arm64
            runner: macos-14
          - platform_id: linux-x86_64
            runner: ubuntu-22.04
          - platform_id: linux-arm64
            runner: ubuntu-24.04-arm
          - platform_id: windows-x86_64
            runner: windows-latest
          - platform_id: windows-arm64
            runner: windows-11-arm
    steps:
      - uses: actions/checkout@v6

      - uses: jdx/mise-action@v3

      - name: Download Python bindings
        id: bindings
        uses: actions/download-artifact@v4
        with:
          name: bindings-python

      - name: Download library (${{ matrix.platform_id }})
        id: lib
        uses: actions/download-artifact@v4
        with:
          name: lib-${{ matrix.platform_id }}

      - name: Assemble package
        shell: bash
        run: |
          BINDINGS_DIR="${{ steps.bindings.outputs.download-path }}"
          LIB_DIR="${{ steps.lib.outputs.download-path }}"
          PKG_DIR="languages/python/src/feeling_rusty"
          cp "$BINDINGS_DIR"/*.py "$PKG_DIR/"
          LIB_FILE=$(find "$LIB_DIR" -type f \( -name '*.so' -o -name '*.dylib' -o -name '*.dll' \) | head -1)
          cp "$LIB_FILE" "$PKG_DIR/"

      - name: Build Python package
        run: uv build
        working-directory: languages/python

      - name: Upload Python package artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-python-${{ matrix.platform_id }}
          path: languages/python/dist/
          retention-days: 3

  package-kotlin:
    name: Package Kotlin
    needs: bindings
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v6

      - uses: jdx/mise-action@v3

      - name: Download Kotlin bindings
        id: bindings
        uses: actions/download-artifact@v4
        with:
          name: bindings-kotlin

      - name: Download all libraries
        id: libs
        uses: actions/download-artifact@v4
        with:
          pattern: lib-*
          merge-multiple: true

      - name: Assemble package
        shell: bash
        run: |
          BINDINGS_DIR="${DOWNLOAD_PATH:?}"
          LIBS_DIR="${LIBS_DOWNLOAD_PATH:?}"
          KOTLIN_DIR="languages/kotlin"
          KOTLIN_SRC="$KOTLIN_DIR/src/main/kotlin"
          KOTLIN_RESOURCES="$KOTLIN_DIR/src/main/resources"
          rm -rf "${KOTLIN_SRC:?}"/*
          (cd "$BINDINGS_DIR" && tar cf - .) | (cd "$KOTLIN_SRC" && tar xf -)
          # platform_id -> JNA resource path (classpath location for native libs)
          for platform_dir in "$LIBS_DIR"/lib-*; do
            [ -d "$platform_dir" ] || continue
            platform_id="${platform_dir##*/lib-}"
            case "$platform_id" in
              darwin-x86_64)  jna_path="darwin-x86-64" ;;
              darwin-arm64)   jna_path="darwin-aarch64" ;;
              linux-x86_64)   jna_path="linux-x86-64" ;;
              linux-arm64)    jna_path="linux-aarch64" ;;
              windows-x86_64) jna_path="win32-x86-64" ;;
              windows-arm64)  jna_path="win32-aarch64" ;;
              *) echo "::warning::Unknown platform_id $platform_id, skipping" ; continue ;;
            esac
            dest="$KOTLIN_RESOURCES/$jna_path"
            mkdir -p "$dest"
            lib_file=$(find "$platform_dir" -type f \( -name '*.so' -o -name '*.dylib' -o -name '*.dll' \) | head -1)
            [ -n "$lib_file" ] && cp "$lib_file" "$dest/"
          done
        env:
          DOWNLOAD_PATH: ${{ steps.bindings.outputs.download-path }}
          LIBS_DOWNLOAD_PATH: ${{ steps.libs.outputs.download-path }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build Kotlin package
        run: gradle build
        working-directory: languages/kotlin

      - name: Upload Kotlin package artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-kotlin
          path: languages/kotlin/build/libs/
          retention-days: 3

  package-swift:
    name: Package Swift
    needs: bindings
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v6

      - name: Download Swift bindings
        id: bindings
        uses: actions/download-artifact@v4
        with:
          name: bindings-swift

      - name: Assemble package
        shell: bash
        run: |
          BINDINGS_DIR="${{ steps.bindings.outputs.download-path }}"
          SWIFT_SRC="languages/swift/Sources/FeelingRusty"
          SWIFT_FFI="languages/swift/Sources/FeelingRustyFFI"
          mkdir -p "$SWIFT_SRC" "$SWIFT_FFI"
          cp "$BINDINGS_DIR"/*.swift "$SWIFT_SRC/"
          cp "$BINDINGS_DIR"/*.h "$SWIFT_FFI/"
          cp "$BINDINGS_DIR"/*.modulemap "$SWIFT_FFI/module.modulemap"

      - name: Upload Swift package artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-swift
          path: languages/swift/
          retention-days: 3

  package-ruby:
    name: Package Ruby (${{ matrix.platform_id }})
    needs: bindings
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform_id: darwin-x86_64
            runner: macos-15-intel
            lib_name: libfeeling_rusty.dylib
          - platform_id: darwin-arm64
            runner: macos-14
            lib_name: libfeeling_rusty.dylib
          - platform_id: linux-x86_64
            runner: ubuntu-22.04
            lib_name: libfeeling_rusty.so
          - platform_id: linux-arm64
            runner: ubuntu-24.04-arm
            lib_name: libfeeling_rusty.so
          - platform_id: windows-x86_64
            runner: windows-latest
            lib_name: feeling_rusty.dll
          - platform_id: windows-arm64
            runner: windows-11-arm
            lib_name: feeling_rusty.dll
    steps:
      - uses: actions/checkout@v6

      - uses: jdx/mise-action@v3

      - name: Download Ruby bindings
        id: bindings
        uses: actions/download-artifact@v4
        with:
          name: bindings-ruby

      - name: Download library (${{ matrix.platform_id }})
        id: lib
        uses: actions/download-artifact@v4
        with:
          name: lib-${{ matrix.platform_id }}

      - name: Assemble package
        shell: bash
        run: |
          BINDINGS_DIR="${{ steps.bindings.outputs.download-path }}"
          LIB_DIR="${{ steps.lib.outputs.download-path }}"
          PKG_DIR="languages/ruby/lib"
          cp "$BINDINGS_DIR"/feeling_rusty.rb "$PKG_DIR/"
          LIB_FILE=$(find "$LIB_DIR" -type f \( -name '*.so' -o -name '*.dylib' -o -name '*.dll' \) | head -1)
          cp "$LIB_FILE" "$PKG_DIR/${{ matrix.lib_name }}"

      - name: Patch ffi_lib to load from gem lib
        shell: bash
        working-directory: languages/ruby
        run: |
          ruby -i -pe "gsub(/ffi_lib 'feeling_rusty'/, \"ffi_lib File.join(__dir__, '${{ matrix.lib_name }}')\")" lib/feeling_rusty.rb

      - name: Build Ruby gem
        shell: bash
        working-directory: languages/ruby
        run: gem build feeling_rusty.gemspec

      - name: Upload Ruby package artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-ruby-${{ matrix.platform_id }}
          path: languages/ruby/*.gem
          retention-days: 3
