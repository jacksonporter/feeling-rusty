name: UniFFI bindings

run-name: Build libraries and generate bindings

permissions:
  contents: read

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  MISE_ENV: ci

jobs:
  build-libs:
    name: Build lib (${{ matrix.platform_id }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform_id: darwin-x86_64
            runner: macos-15-intel
            target: x86_64-apple-darwin
            lib_file: libfeeling_rusty.dylib
          - platform_id: darwin-arm64
            runner: macos-14
            target: aarch64-apple-darwin
            lib_file: libfeeling_rusty.dylib
          - platform_id: linux-x86_64
            runner: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            lib_file: libfeeling_rusty.so
          - platform_id: linux-arm64
            runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            lib_file: libfeeling_rusty.so
          - platform_id: windows-x86_64
            runner: windows-latest
            target: x86_64-pc-windows-msvc
            lib_file: feeling_rusty.dll
          - platform_id: windows-arm64
            runner: windows-11-arm
            target: aarch64-pc-windows-msvc
            lib_file: feeling_rusty.dll
    steps:
      - uses: actions/checkout@v6

      - uses: jdx/mise-action@v3

      - uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-${{ runner.os }}-${{ matrix.platform_id }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Rust target
        run: rustup target add ${{ matrix.target }}

      - name: Build release cdylib
        run: cargo build --release --target ${{ matrix.target }} --lib

      - name: Copy library to staging
        shell: bash
        run: |
          mkdir -p staging
          cp "target/${{ matrix.target }}/release/${{ matrix.lib_file }}" staging/

      - name: Upload library artifact
        uses: actions/upload-artifact@v4
        with:
          name: lib-${{ matrix.platform_id }}
          path: staging/
          retention-days: 3

  build-bindgen:
    name: Build uniffi-bindgen
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v6

      - uses: jdx/mise-action@v3

      - uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-${{ runner.os }}-bindgen-${{ hashFiles('**/Cargo.lock') }}

      - name: Build uniffi-bindgen binary
        run: cargo build --release --bin uniffi-bindgen --features cli

      - name: Upload uniffi-bindgen binary
        uses: actions/upload-artifact@v4
        with:
          name: uniffi-bindgen-binary
          path: target/release/uniffi-bindgen
          retention-days: 3

  bindings:
    name: Bindings (${{ matrix.language }})
    needs: [build-libs, build-bindgen]
    runs-on: ubuntu-24.04-arm
    strategy:
      fail-fast: false
      matrix:
        language: [kotlin, swift, python, ruby]
    steps:
      - uses: actions/checkout@v6

      - name: Download uniffi-bindgen binary
        uses: actions/download-artifact@v4
        with:
          name: uniffi-bindgen-binary

      - name: Locate bindgen binary
        id: bindgen
        run: |
          BINDGEN=$(find . -name uniffi-bindgen -type f | head -1)
          chmod +x "$BINDGEN"
          echo "path=$BINDGEN" >> "$GITHUB_OUTPUT"

      # Any one library has the same embedded API metadata; we only need it to run bindgen
      - name: Download library artifact (any platform)
        id: download-lib
        uses: actions/download-artifact@v4
        with:
          name: lib-linux-x86_64

      - name: Detect library path
        id: lib
        run: |
          LIB_DIR="${{ steps.download-lib.outputs.download-path }}"
          LIB_PATH=$(find "$LIB_DIR" -type f \( -name '*.dylib' -o -name '*.so' -o -name '*.dll' \) | head -1)
          if [ -z "$LIB_PATH" ]; then
            echo "::error::No library file found in $LIB_DIR"
            exit 1
          fi
          echo "path=$LIB_PATH" >> "$GITHUB_OUTPUT"

      - name: Generate bindings
        run: |
          "${{ steps.bindgen.outputs.path }}" generate \
            --library "${{ steps.lib.outputs.path }}" \
            --language ${{ matrix.language }} \
            --out-dir out

      - name: Upload bindings artifact
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.language }}
          path: out/
          retention-days: 3

  package-python:
    name: Package Python (${{ matrix.platform_id }})
    needs: bindings
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform_id: darwin-x86_64
            runner: macos-15-intel
          - platform_id: darwin-arm64
            runner: macos-14
          - platform_id: linux-x86_64
            runner: ubuntu-22.04
          - platform_id: linux-arm64
            runner: ubuntu-24.04-arm
          - platform_id: windows-x86_64
            runner: windows-latest
          - platform_id: windows-arm64
            runner: windows-11-arm
    steps:
      - uses: actions/checkout@v6

      - uses: jdx/mise-action@v3

      - name: Download Python bindings
        id: bindings
        uses: actions/download-artifact@v4
        with:
          name: bindings-python

      - name: Download library (${{ matrix.platform_id }})
        id: lib
        uses: actions/download-artifact@v4
        with:
          name: lib-${{ matrix.platform_id }}

      - name: Assemble package
        shell: bash
        run: |
          BINDINGS_DIR="${{ steps.bindings.outputs.download-path }}"
          LIB_DIR="${{ steps.lib.outputs.download-path }}"
          PKG_DIR="languages/python/src/feeling_rusty"
          cp "$BINDINGS_DIR"/*.py "$PKG_DIR/"
          LIB_FILE=$(find "$LIB_DIR" -type f \( -name '*.so' -o -name '*.dylib' -o -name '*.dll' \) | head -1)
          cp "$LIB_FILE" "$PKG_DIR/"

      - name: Build Python package
        run: uv build
        working-directory: languages/python

      - name: Upload Python package artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-python-${{ matrix.platform_id }}
          path: languages/python/dist/
          retention-days: 3
